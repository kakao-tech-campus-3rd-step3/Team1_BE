<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Push í…ŒìŠ¤íŠ¸</title>
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .status {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .status.info {
      background: #e3f2fd;
      color: #1976d2;
    }

    .status.success {
      background: #e8f5e9;
      color: #388e3c;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }

    button {
      flex: 1;
      padding: 15px 25px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #subscribeBtn {
      background: #4CAF50;
      color: white;
    }

    #subscribeBtn:hover:not(:disabled) {
      background: #45a049;
    }

    .push-form {
      background: #f5f5f5;
      padding: 25px;
      border-radius: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }

    input[type="text"], textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    input[type="text"]:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    #sendPushBtn {
      width: 100%;
      background: #667eea;
      color: white;
    }

    #sendPushBtn:hover:not(:disabled) {
      background: #5568d3;
    }

    .info-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
      font-size: 13px;
      color: #856404;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ”” Web Push í…ŒìŠ¤íŠ¸</h1>
  <p class="subtitle">Spring Boot + Web Push API í…ŒìŠ¤íŠ¸ í˜ì´ì§€</p>

  <div id="status" class="status info">
    Service Workerë¥¼ ë“±ë¡í•˜ëŠ” ì¤‘...
  </div>

  <div class="button-group">
    <input type="text" id="memberIdInput" placeholder="MemberId (UUID ì…ë ¥)"
           style="flex:2; padding:12px; border-radius:8px; border:2px solid #ddd;">
    <button id="subscribeBtn" disabled>ğŸ”” ì•Œë¦¼ êµ¬ë…í•˜ê¸°</button>
  </div>

  <div class="push-form">
    <h2 style="margin-bottom: 20px; color: #333; font-size: 20px;">í‘¸ì‹œ ì•Œë¦¼ ë³´ë‚´ê¸°</h2>
    <div class="form-group">
      <label for="title">ì œëª©</label>
      <input type="text" id="title" placeholder="ì•Œë¦¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="í…ŒìŠ¤íŠ¸ ì•Œë¦¼">
    </div>
    <div class="form-group">
      <label for="body">ë‚´ìš©</label>
      <textarea id="body" placeholder="ì•Œë¦¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">Web Push í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤!</textarea>
    </div>
    <div class="form-group">
      <label for="icon">ì•„ì´ì½˜ URL (ì„ íƒì‚¬í•­)</label>
      <input type="text" id="icon" placeholder="https://example.com/icon.png (ë¹„ì›Œë‘ê±°ë‚˜ ìœ íš¨í•œ URL ì…ë ¥)"
             value="">
    </div>
    <button id="sendPushBtn">ğŸ“¤ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡</button>
  </div>

  <div class="info-box">
    <strong>ğŸ’¡ ì‚¬ìš© ë°©ë²•:</strong><br>
    1. MemberId ì…ë ¥ í›„ "ì•Œë¦¼ êµ¬ë…í•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í‘¸ì‹œ ì•Œë¦¼ì„ í—ˆìš©í•˜ì„¸ìš”<br>
    2. ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”<br>
    3. "í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”<br>
    4. í‘¸ì‹œ ì•Œë¦¼ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤!
  </div>
</div>

<script>
  const statusDiv = document.getElementById('status');
  const subscribeBtn = document.getElementById('subscribeBtn');
  const sendPushBtn = document.getElementById('sendPushBtn');
  const memberIdInput = document.getElementById('memberIdInput');
  const titleInput = document.getElementById('title');
  const bodyInput = document.getElementById('body');
  const iconInput = document.getElementById('icon');

  let isSubscribed = false;

  // Service Worker ë“±ë¡
  if ('serviceWorker' in navigator && 'PushManager' in window) {
    navigator.serviceWorker.register('/sw.js')
    .then(registration => {
      console.log('Service Worker ë“±ë¡ ì„±ê³µ:', registration);
      statusDiv.textContent = 'âœ… Service Worker ë“±ë¡ ì™„ë£Œ! ì•Œë¦¼ êµ¬ë…ì„ ì§„í–‰í•˜ì„¸ìš”.';
      statusDiv.className = 'status success';
      subscribeBtn.disabled = false;
    })
    .catch(error => {
      console.error('Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
      statusDiv.textContent = 'âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨: ' + error.message;
      statusDiv.className = 'status error';
    });
  } else {
    statusDiv.textContent = 'âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” Push APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    statusDiv.className = 'status error';
  }

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
  }

  subscribeBtn.addEventListener('click', async () => {
    if (isSubscribed) {
      statusDiv.textContent = 'ì´ë¯¸ êµ¬ë…ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
      statusDiv.className = 'status info';
      return;
    }

    const memberId = memberIdInput.value.trim();
    if (!memberId) {
      alert('MemberIdë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
      return;
    }

    try {
      const keyResponse = await fetch('/api/publicKey');
      const keyData = await keyResponse.json();
      const publicKey = keyData.publicKey;

      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey)
      });

      // ì„œë²„ì— êµ¬ë… ì •ë³´ ì „ì†¡ (memberId í¬í•¨)
      const payload = {
        memberId: memberId,
        endpoint: subscription.endpoint,
        keys: {
          p256dh: subscription.getKey('p256dh') ? btoa(
              String.fromCharCode(...new Uint8Array(subscription.getKey('p256dh')))) : '',
          auth: subscription.getKey('auth') ? btoa(
              String.fromCharCode(...new Uint8Array(subscription.getKey('auth')))) : ''
        }
      };

      const response = await fetch('/api/subscribeByMemberId', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (response.ok) {
        isSubscribed = true;
        subscribeBtn.textContent = 'âœ… êµ¬ë… ì™„ë£Œ';
        subscribeBtn.disabled = true;
        statusDiv.textContent = 'âœ… ' + result.message + ' (êµ¬ë…ì ìˆ˜: ' + result.subscriberCount + ')';
        statusDiv.className = 'status success';
      } else {
        throw new Error(result.error || 'êµ¬ë… ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('êµ¬ë… ì‹¤íŒ¨:', error);
      statusDiv.textContent = 'âŒ êµ¬ë… ì‹¤íŒ¨: ' + error.message;
      statusDiv.className = 'status error';
    }
  });

  sendPushBtn.addEventListener('click', async () => {
    const title = titleInput.value.trim();
    const body = bodyInput.value.trim();
    const icon = iconInput.value.trim();
    if (!title || !body) {
      alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
      return;
    }

    const message = {title, body, icon: icon || ''};

    try {
      const response = await fetch('/api/push', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(message)
      });
      const result = await response.json();

      if (response.ok) {
        statusDiv.textContent = 'âœ… ' + result.message + (result.sentTo ? ' (ì „ì†¡ ëŒ€ìƒ: ' + result.sentTo
            + 'ëª…)' : '');
        statusDiv.className = 'status success';
      } else {
        throw new Error(result.error || 'ì „ì†¡ ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('í‘¸ì‹œ ì „ì†¡ ì‹¤íŒ¨:', error);
      statusDiv.textContent = 'âŒ í‘¸ì‹œ ì „ì†¡ ì‹¤íŒ¨: ' + error.message;
      statusDiv.className = 'status error';
    }
  });
</script>
</body>
</html>
